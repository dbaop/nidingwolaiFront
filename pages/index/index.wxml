<!-- 首页 -->
<view class="container">


  <!-- 搜索栏 -->
  <view class="search-bar">
    <input class="search-input" placeholder="搜索活动、地点或标签" bindinput="onSearchInput" />
    <image class="search-icon" src="https://picsum.photos/seed/search/20/20"></image>
  </view>

  <!-- 活动分类 -->
  <view class="category-section">
    <scroll-view scroll-x="true" class="category-scroll">
      <view class="category-item {{currentCategory == 'k歌' ? 'active' : ''}}" bindtap="switchCategory" data-category="k歌">
        <image class="category-icon" src="https://picsum.photos/seed/karaoke/40/40"></image>
        <text class="category-text">K歌</text>
      </view>
      <view class="category-item {{currentCategory == '剧本杀' ? 'active' : ''}}" bindtap="switchCategory" data-category="剧本杀">
        <image class="category-icon" src="https://picsum.photos/seed/script/40/40"></image>
        <text class="category-text">剧本杀</text>
      </view>
      <view class="category-item {{currentCategory == '桌游' ? 'active' : ''}}" bindtap="switchCategory" data-category="桌游">
        <image class="category-icon" src="https://picsum.photos/seed/boardgame/40/40"></image>
        <text class="category-text">桌游</text>
      </view>
      <view class="category-item {{currentCategory == '爬山' ? 'active' : ''}}" bindtap="switchCategory" data-category="爬山">
        <image class="category-icon" src="https://picsum.photos/seed/hiking/40/40"></image>
        <text class="category-text">爬山</text>
      </view>
      <view class="category-item {{currentCategory == '饭局' ? 'active' : ''}}" bindtap="switchCategory" data-category="饭局">
        <image class="category-icon" src="https://picsum.photos/seed/dinner/40/40"></image>
        <text class="category-text">饭局</text>
      </view>
    </scroll-view>
  </view>

  <!-- 附近活动列表 -->
  <view class="activity-section">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text>加载中...</text>
    </view>
    
    <!-- 错误提示 -->
    <view wx:elif="{{error}}" class="error-container">
      <image src="https://picsum.photos/seed/empty/200/200"></image>
      <text>{{error}}</text>
      <button class="retry-btn" bindtap="loadActivities">重新加载</button>
    </view>
    
    <!-- 活动列表 -->
    <view wx:else>
      <view class="section-title">
        <text class="title-text">附近的活动</text>
        <text class="more-text" bindtap="onMoreClick">更多</text>
      </view>

      <!-- 空数据提示 -->
      <view wx:if="{{activities.length === 0}}" class="empty-container">
        <image src="https://picsum.photos/seed/empty/200/200" class="empty-image"></image>
        <text class="empty-text">附近暂无活动</text>
        <text class="empty-tip">快去创建一个吧！</text>
      </view>

      <view wx:else class="activity-list">
        <view class="activity-card" wx:for="{{activities}}" wx:key="id" bindtap="goToActivityDetail" data-id="{{item.id}}">
          <image class="activity-image" src="{{item.imageWithFallback}}" mode="aspectFill" binderror="onImageError" data-idx="{{index}}"></image>
          <view class="activity-info">
            <view class="activity-header">
              <text class="activity-title">{{item.title}}</text>
              <text class="activity-price">¥{{item.price}}/人</text>
            </view>
            <view class="activity-meta">
              <image class="meta-icon" src="https://picsum.photos/seed/time/20/20"></image>
              <text class="meta-text">{{item.time}}</text>
            </view>
            <view class="activity-meta">
              <image class="meta-icon" src="https://picsum.photos/seed/location/20/20"></image>
              <text class="meta-text">{{item.location}}</text>
            </view>
            <view class="activity-participants">
              <text class="participants-text">已有 {{item.currentPeople}}/{{item.totalPeople}} 人</text>
              <view class="participants-avatars">
                <image class="avatar" wx:for="{{item.avatarsWithFallback}}" wx:for-item="avatar" wx:key="index" src="{{avatar}}"></image>
              </view>
            </view>
            <view class="activity-footer">
              <view class="activity-tags">
                <text class="tag" wx:for="{{item.tags}}" wx:key="index">{{item}}</text>
              </view>
              <!-- 根据报名状态显示不同按钮 -->
              <button class="join-btn {{item.is_enrolled ? 'enrolled' : ''}}" 
                      wx:if="{{!item.is_enrolled}}"
                      catchtap="showJoinDialog" 
                      data-id="{{item.id}}" 
                      data-price="{{item.price}}" 
                      data-title="{{item.title}}">
                申请加入
              </button>
              <view class="join-status" wx:elif="{{item.is_enrolled}}">
                <text wx:if="{{item.enrollment_status === 'approved'}}" class="status-approved">已报名</text>
                <text wx:elif="{{item.enrollment_status === 'pending'}}" class="status-pending">审核中</text>
                <text wx:elif="{{item.enrollment_status === 'rejected'}}" class="status-rejected">已拒绝</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 报名确认对话框 -->
  <view class="join-modal" wx:if="{{showJoinModal}}">
    <view class="modal-mask" bindtap="closeJoinDialog"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">申请加入活动</text>
        <text class="close-icon" bindtap="closeJoinDialog">×</text>
      </view>
      <view class="modal-body">
        <view class="activity-detail">
          <text class="detail-title">{{selectedActivity.title}}</text>
          <view class="detail-row">
            <text class="detail-label">活动时间：</text>
            <text class="detail-value">{{selectedActivity.time}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">活动地点：</text>
            <text class="detail-value">{{selectedActivity.location}}</text>
          </view>
        </view>

        <view class="deposit-info">
          <view class="deposit-row">
            <text class="deposit-label">押金金额：</text>
            <text class="deposit-price">¥{{selectedActivity.deposit_amount || selectedActivity.deposit || 0}}</text>
          </view>
          <view class="deposit-tips" wx:if="{{selectedActivity.deposit_amount > 0}}">
            <text class="tip-icon">ℹ️</text>
            <text class="tip-text">报名后需支付押金</text>
          </view>
          <view class="deposit-tips" wx:if="{{selectedActivity.deposit_amount === 0 || !selectedActivity.deposit_amount}}">
            <text class="tip-icon">✓</text>
            <text class="tip-text">本活动无需押金</text>
          </view>
          <view class="refund-rule">
            <text class="rule-title">时间限制：</text>
            <text class="rule-text">活动开始前1小时内不允许报名，2小时内不允许取消</text>
          </view>
        </view>

        <view class="message-input">
          <textarea class="message-textarea" placeholder="输入报名留言（选填）" bindinput="onMessageInput" value="{{joinMessage}}"></textarea>
        </view>
      </view>
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeJoinDialog">取消</button>
        <button class="confirm-btn" bindtap="confirmJoin">确认报名</button>
      </view>
    </view>
  </view>
</view>